name: Changelog Sync

on:
  push:
    paths:
      - 'CHANGELOG.md'
    branches: [main]
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Manual trigger fallback

permissions:
  contents: write

jobs:
  sync:
    name: Sync Changelog to docs/
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Copy CHANGELOG.md to docs/
        run: |
          # Ensure docs directory exists
          mkdir -p docs
          
          # Copy CHANGELOG.md to docs/changelog.md
          cp CHANGELOG.md docs/changelog.md
          
          echo "âœ… Copied CHANGELOG.md â†’ docs/changelog.md"
      
      - name: Copy to versioned docs (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          # Extract version from tag (e.g., refs/tags/v0.0.0 â†’ 0.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Extract major version (e.g., 0.0.0 â†’ 0)
          MAJOR_VERSION=$(echo $VERSION | cut -d. -f1)
          
          # Create versioned directory
          mkdir -p "docs/${MAJOR_VERSION}.x"
          
          # Copy CHANGELOG.md to versioned file
          cp CHANGELOG.md "docs/${MAJOR_VERSION}.x/CHANGELOG-v${VERSION}.md"
          
          echo "âœ… Copied CHANGELOG.md â†’ docs/${MAJOR_VERSION}.x/CHANGELOG-v${VERSION}.md"
          
          # Add to git
          git add "docs/${MAJOR_VERSION}.x/CHANGELOG-v${VERSION}.md"
      
      - name: Commit changes
        continue-on-error: true  # Don't block release on sync failure
        run: |
          git add docs/changelog.md
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit (changelog already in sync)"
          else
            if [[ "$GITHUB_REF" == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
              git commit -m "docs: Sync CHANGELOG.md for version v${VERSION} [automated]"
            else
              git commit -m "docs: Sync CHANGELOG.md to docs/changelog.md [automated]"
            fi
            git push
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: Display sync info
        run: |
          echo "### ðŸ“ Changelog Sync" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination:** docs/changelog.md" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Synced" >> $GITHUB_STEP_SUMMARY
