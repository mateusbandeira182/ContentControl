# Migration Guide: v0.5.2 → v0.6.0

**ContentControl Library - Run-Level SDT & TableBuilder v2 API**  
**Migration Date**: February 2026  
**Complexity**: Low-Medium (1 behavioral change, 5 deprecations)  
**Estimated Time**: 10-30 minutes per affected file

---

## Overview

Version 0.6.0 introduces **run-level SDT wrapping** (CT_SdtContentRun) for individual `<w:r>` elements and a redesigned **TableBuilder v2 API** that integrates directly with PHPWord's Table objects.

**Key Changes:**
- ✅ **NEW**: Run-level SDT support (`runLevel => true` in config)
- ✅ **NEW**: `TableBuilder` constructor accepts PHPWord `Table` objects
- ✅ **NEW**: `TableBuilder::addContentControl()` functional delegation
- ⚠️ **CHANGED**: `TableBuilder::addContentControl()` signature (was always-throwing stub)
- ⚠️ **DEPRECATED**: Fluent builder API (`addRow()`, `addCell()`, `withContentControl()`, `addText()`, `addImage()`)

**Impact Assessment:**
- **Zero-impact users**: Users only using `ContentControl` class directly (no changes required)
- **Low-impact users**: Users of `TableBuilder` fluent API (deprecation warnings only, code still works)
- **Medium-impact users**: Users calling `addContentControl()` on TableBuilder with array argument (signature changed)

---

## Breaking Changes

### TableBuilder::addContentControl() Signature Changed

#### What Changed

In v0.5.1, `addContentControl()` was a stub that always threw `ContentControlException`. In v0.6.0, it became a functional method with a new signature:

```php
// ❌ v0.5.1 (always threw)
$builder->addContentControl(['tag' => 'my-tag']);

// ✅ v0.6.0 (functional delegation)
$builder->addContentControl($element, ['tag' => 'my-tag']);
```

#### Migration

Since the old method always threw an exception, **no user code should have depended on calling it successfully**. If you had a `try/catch` around this call, you can now remove it:

```php
// ❌ Before (v0.5.1)
try {
    $builder->addContentControl(['tag' => 'my-tag']);
} catch (ContentControlException $e) {
    // Workaround code...
}

// ✅ After (v0.6.0)
$builder->addContentControl($textElement, [
    'tag' => 'my-tag',
    'runLevel' => true,
    'inlineLevel' => true,
]);
```

---

## New Features

### Run-Level SDT Wrapping

Run-level SDTs wrap individual `<w:r>` (text run) elements inside `<w:p>` (paragraphs), conforming to **ECMA-376 CT_SdtContentRun**. This enables fine-grained content protection at the text-run level.

#### Basic Usage

```php
$cc = new ContentControl();
$section = $cc->addSection();

// Single text element
$text = $section->addText('Editable Field');
$cc->addContentControl($text, [
    'tag' => 'field-1',
    'runLevel' => true,  // NEW: wraps <w:r> instead of <w:p>
]);
```

#### TextRun with Multiple Tagged Runs

```php
$textRun = $section->addTextRun();
$firstName = $textRun->addText('Alice', ['bold' => true]);
$textRun->addText(' ');  // Not wrapped
$lastName = $textRun->addText('Smith');

$cc->addContentControl($firstName, [
    'tag' => 'first-name',
    'runLevel' => true,
]);

$cc->addContentControl($lastName, [
    'tag' => 'last-name',
    'runLevel' => true,
]);
```

#### Run-Level in Table Cells

For text inside table cells, combine `runLevel` with `inlineLevel`:

```php
$table = $section->addTable();
$row = $table->addRow();
$cell = $row->addCell(3000);
$text = $cell->addText('Cell Value');

$cc->addContentControl($text, [
    'tag' => 'cell-value',
    'runLevel' => true,     // Wrap <w:r>
    'inlineLevel' => true,  // Search inside <w:tc>
]);
```

### TableBuilder Constructor with Table

The `TableBuilder` constructor now accepts a PHPWord `Table` object directly:

```php
use MkGrow\ContentControl\Bridge\TableBuilder;

// Create table via PHPWord API
$table = $section->addTable(['borderSize' => 6]);
$row = $table->addRow();
$cell = $row->addCell(3000);
$text = $cell->addText('John Doe');

// Pass table to TableBuilder for SDT registration
$builder = new TableBuilder($table);
```

### Functional addContentControl()

`TableBuilder::addContentControl()` now delegates to `ContentControl::addContentControl()`:

```php
$builder = new TableBuilder($table);
$builder->addContentControl($text, [
    'tag' => 'first-name',
    'alias' => 'First Name',
    'runLevel' => true,
    'inlineLevel' => true,
]);
```

---

## Deprecations

All deprecated methods continue to work in v0.6.0. They will be **removed in v0.8.0** (estimated H2 2027).

### TableBuilder::addRow()

```php
// ⚠️ Deprecated (v0.6.0)
$builder->addRow()
    ->addCell(3000)->addText('Name')->end()
    ->end();

// ✅ Recommended replacement
$table = $section->addTable();
$row = $table->addRow();
$cell = $row->addCell(3000);
$text = $cell->addText('Name');

$builder = new TableBuilder($table);
$builder->addContentControl($text, ['tag' => 'name']);
```

### RowBuilder::addCell()

```php
// ⚠️ Deprecated (v0.6.0)
$row = $builder->addRow();
$row->addCell(3000)->addText('Value');

// ✅ Recommended replacement
$row = $table->addRow();
$cell = $row->addCell(3000);
$text = $cell->addText('Value');
```

### CellBuilder::withContentControl()

```php
// ⚠️ Deprecated (v0.6.0)
$cell->withContentControl(['tag' => 'price'])->addText('$99');

// ✅ Recommended replacement
$text = $cell->addText('$99');  // PHPWord Cell
$builder->addContentControl($text, ['tag' => 'price']);
```

### CellBuilder::addText()

```php
// ⚠️ Deprecated (v0.6.0)
$cellBuilder->addText('Content', ['bold' => true]);

// ✅ Recommended replacement
$text = $cell->addText('Content', ['bold' => true]);  // PHPWord Cell
```

### CellBuilder::addImage()

```php
// ⚠️ Deprecated (v0.6.0)
$cellBuilder->addImage('photo.jpg', ['width' => 100]);

// ✅ Recommended replacement
$image = $cell->addImage('photo.jpg', ['width' => 100]);  // PHPWord Cell
```

---

## Complete Migration Example

### Before (v0.5.2 Fluent API)

```php
$builder = new TableBuilder();
$builder->setStyles(['borderSize' => 6]);

$builder->addRow()
    ->addCell(3000)
        ->withContentControl(['tag' => 'name', 'alias' => 'Name'])
        ->addText('John Doe')
        ->end()
    ->addCell(3000)
        ->withContentControl(['tag' => 'email', 'alias' => 'Email'])
        ->addText('john@example.com')
        ->end()
    ->end();

$builder->getContentControl()->save('output.docx');
```

### After (v0.6.0 Direct PHPWord API)

```php
$cc = new ContentControl();
$section = $cc->addSection();
$table = $section->addTable(['borderSize' => 6]);

$row = $table->addRow();
$nameCell = $row->addCell(3000);
$nameText = $nameCell->addText('John Doe');

$emailCell = $row->addCell(3000);
$emailText = $emailCell->addText('john@example.com');

$builder = new TableBuilder($table);
$builder->addContentControl($nameText, [
    'tag' => 'name',
    'alias' => 'Name',
    'runLevel' => true,
    'inlineLevel' => true,
]);
$builder->addContentControl($emailText, [
    'tag' => 'email',
    'alias' => 'Email',
    'runLevel' => true,
    'inlineLevel' => true,
]);

$cc->save('output.docx');
```

---

## Removal Timeline

| Feature | Deprecated | Removal Target | Window |
|---------|-----------|----------------|--------|
| `TableBuilder::addRow()` | v0.6.0 | v0.8.0 | ~18 months |
| `RowBuilder::addCell()` | v0.6.0 | v0.8.0 | ~18 months |
| `CellBuilder::withContentControl()` | v0.6.0 | v0.8.0 | ~18 months |
| `CellBuilder::addText()` | v0.6.0 | v0.8.0 | ~18 months |
| `CellBuilder::addImage()` | v0.6.0 | v0.8.0 | ~18 months |
| `RowBuilder::end()` | v0.5.1 | v0.7.0 | ~18 months |
| `CellBuilder::end()` | v0.5.1 | v0.7.0 | ~18 months |

---

*Generated for ContentControl v0.6.0 | ISO/IEC 29500-1:2016 §17.5.2*
