# Migration Guide: v0.6.0 â†’ v0.7.0

**ContentControl Library - Breaking end() Removal & ContentProcessor TableBuilder Support**  
**Migration Date**: February 2026  
**Complexity**: Low (1 breaking change, 2 new features)  
**Estimated Time**: 10-20 minutes per affected file

---

## Overview

Version 0.7.0 completes the 18-month deprecation cycle for `end()` methods and introduces `TableBuilder` support in `ContentProcessor::replaceContent()`.

**Key Changes:**
- ðŸ”´ **BREAKING**: `RowBuilder::end()` and `CellBuilder::end()` removed
- âœ… **NEW**: `ContentProcessor::replaceContent()` accepts `TableBuilder`
- âœ… **NEW**: `TableBuilder::serializeWithSdts()` public method
- âœ… **NEW**: `runLevel` cross-validation in `SDTInjector`
- ðŸ§¹ **REMOVED**: `TableBuilder::generateTableHash()` (private, dead code)

**Impact Assessment:**
- **Zero-impact users**: Users only using `ContentControl` class directly (no changes required)
- **Low-impact users**: Users who already adopted the variable pattern from v0.6.0 deprecation warnings
- **Medium-impact users**: Users still calling `->end()` on `RowBuilder`/`CellBuilder` (must migrate)

---

## Breaking Changes

### RowBuilder::end() and CellBuilder::end() Removed

#### What Changed

The `end()` methods on `RowBuilder` and `CellBuilder` were deprecated since v0.5.1 and have been removed in v0.7.0. These methods returned the parent builder to enable deep chaining, but this pattern is foreign to PHPWord conventions.

#### Migration

Replace chained `->end()` calls with the variable assignment pattern:

```php
// âŒ Before (v0.6.0) - No longer works
$builder->addRow()
    ->addCell(3000)->addText('Product')->end()
    ->addCell(2000)->addText('Price')->end()
    ->end();

// âœ… After (v0.7.0)
$row = $builder->addRow();
$row->addCell(3000)->addText('Product');
$row->addCell(2000)->addText('Price');
```

For tables with Content Controls (cell-level SDTs):

```php
// âŒ Before (v0.6.0)
$builder->addRow()
    ->addCell(4000)
        ->withContentControl(['tag' => 'emp-name', 'inlineLevel' => true])
        ->addText('John Doe')
        ->end()
    ->addCell(3000)
        ->addText('Engineering')
        ->end()
    ->end();

// âœ… After (v0.7.0)
$row = $builder->addRow();
$row->addCell(4000)
    ->withContentControl(['tag' => 'emp-name', 'inlineLevel' => true])
    ->addText('John Doe');
$row->addCell(3000)
    ->addText('Engineering');
```

#### Quick Search & Replace

Find all `->end()` calls in your codebase:

```bash
grep -rn '->end()' src/ --include="*.php"
```

Each `->end()` on a `CellBuilder` (returns `RowBuilder`) should be removed. Each `->end()` on a `RowBuilder` (returns `TableBuilder`) should be replaced by assigning the `addRow()` result to a variable.

---

## New Features

### ContentProcessor::replaceContent() with TableBuilder

`replaceContent()` now accepts a `TableBuilder` instance as the replacement value, enabling SDT-aware table injection into existing DOCX templates.

```php
use MkGrow\ContentControl\ContentProcessor;
use MkGrow\ContentControl\Bridge\TableBuilder;

$processor = new ContentProcessor('template.docx');

$builder = new TableBuilder();
$row = $builder->addRow();
$row->addCell(3000)->addText('Product');
$row->addCell(2000)->addText('Price');

// Replaces the SDT with tag 'table-placeholder' with the full table XML (including SDTs)
$processor->replaceContent('table-placeholder', $builder);
$processor->save('output.docx');
```

**Signature (widened):**
```php
public function replaceContent(string $tag, string|AbstractElement|TableBuilder $value): bool
```

The `TableBuilder` path serializes the table with all registered SDTs, then injects the resulting XML fragment into the target SDT content.

### TableBuilder::serializeWithSdts()

New public method that serializes the builder's table to XML with all registered SDTs applied:

```php
$builder = new TableBuilder();
$row = $builder->addRow();
$row->addCell(3000)
    ->withContentControl(['tag' => 'cell-data'])
    ->addText('Value');

$xml = $builder->serializeWithSdts();
// Returns raw XML string containing <w:tbl> with nested <w:sdt> elements
```

This method is primarily used internally by `ContentProcessor::replaceContent()`, but is available for advanced use cases like custom XML manipulation.

### runLevel Cross-Validation

`SDTInjector` now validates that `runLevel=true` is only used with `Text` elements. Using it with `TextRun`, `Table`, or `Image` elements now throws `InvalidArgumentException`:

```php
// âŒ Throws InvalidArgumentException in v0.7.0
$cc->addContentControl($table, ['runLevel' => true]);
// Message: "runLevel SDT is only supported for Text elements. Got: Table"

// âœ… Correct usage
$cc->addContentControl($text, ['runLevel' => true]);
```

---

## Internal Changes (No User Impact)

### generateTableHash() Removed

The private method `TableBuilder::generateTableHash()` was dead code since v0.4.2 (replaced by UUID v5 in `ElementIdentifier`). It has been removed with no impact on public API.

### PHPStan Baseline

The baseline was updated to reflect the `end()` removal:
- **Removed**: `RowBuilder::end()` result-unused suppression (12 occurrences in tests)
- **Added**: `CellBuilder` constructor unused `$parent` parameter (kept for backward compatibility)
- **Added**: `method_exists` regression guard tests for `end()` removal verification

---

## Deprecation Timeline

| Version | Change | Status |
|---------|--------|--------|
| v0.5.1 | `end()` deprecated | âœ… Done |
| v0.6.0 | Fluent API deprecated (`addRow`, `addCell`, `withContentControl`, `addText`, `addImage`) | âœ… Done |
| **v0.7.0** | **`end()` removed** | **âœ… This release** |
| v0.8.0 | Entire fluent API removed (`RowBuilder`, `CellBuilder`, `TableBuilder::addRow()`) | ðŸ”œ Planned |
| v1.0.0 | `createTable()` removed | ðŸ”œ Planned |

---

## Table Ownership Constraint

When using `TableBuilder::serializeWithSdts()` or `ContentProcessor::replaceContent()` with a `TableBuilder`, the table **must be created through the builder's own ContentControl instance**:

```php
// âœ… Correct: Table created via builder's addRow()
$builder = new TableBuilder();
$row = $builder->addRow();
$row->addCell(3000)->addText('Value');
$xml = $builder->serializeWithSdts();  // Works

// âŒ Anti-pattern: External table from different PhpWord tree
$phpWord = new PhpWord();
$table = $phpWord->addSection()->addTable();
// This table is NOT owned by the builder's ContentControl
```

For advanced scenarios requiring external tables, use the `TableBuilder` constructor with a `ContentControl` instance and reflection to set the table property (see test `TB-SER-03` for reference).
