# Migration Guide: v0.5.0 → v0.5.1

**ContentControl Library - TableBuilder Refactoring**  
**Migration Date**: February 2026  
**Complexity**: Low (only 1 breaking change, <8% of users affected)  
**Estimated Time**: 5-15 minutes per affected file

---

## Overview

Version 0.5.1 addresses a critical OOXML specification violation in the TableBuilder component while introducing a new decorator pattern for external table integration.

**Key Changes:**
- ❌ **BREAKING**: `TableBuilder::addContentControl()` removed (OOXML compliance fix)
- ⚠️ **DEPRECATED**: `RowBuilder::end()` and `CellBuilder::end()` (removal in v0.7.0)
- ✅ **NEW**: `TableBuilder::setTable()` method (decorator pattern)

**Impact Assessment:**
- **High-impact users**: Anyone using `$builder->addContentControl()` (estimated <8%)
- **Low-impact users**: All other TableBuilder users (no changes required)
- **Zero-impact users**: Users only using ContentControl class directly

---

## Breaking Changes

### TableBuilder::addContentControl() Removed

#### Why This Changed

The `addContentControl()` method enabled creating **nested SDT structures** that violate ISO/IEC 29500-1:2016 §17.5.2.30:

```xml
<!-- INVALID OOXML (created by v0.5.0) -->
<w:sdt>  <!-- Table-level SDT -->
    <w:sdtContent>
        <w:tbl>
            <w:tr>
                <w:tc>
                    <w:sdt>  <!-- Cell-level SDT (nested!) -->
                        <w:sdtContent>...</w:sdtContent>
                    </w:sdt>
                </w:tc>
            </w:tr>
        </w:tbl>
    </w:sdtContent>
</w:sdt>
```

**Result**: Document corruption in Microsoft Word, LibreOffice, and Google Docs.

**Decision**: Remove method entirely in patch version (v0.5.1) rather than wait for v0.6.0 to prevent users from creating broken documents.

---

#### Migration Path 1: Manual Table-Level SDT (Not Recommended)

If you truly need a table-level Content Control (rare use case), apply it manually **after** building the table:

**Before (v0.5.0 - BROKEN):**
```php
use MkGrow\ContentControl\Bridge\TableBuilder;
use MkGrow\ContentControl\ContentControl;

$builder = new TableBuilder();
$builder->addContentControl([  // ❌ Removed in v0.5.1
    'tag' => 'invoice-table',
    'alias' => 'Invoice Items',
    'type' => ContentControl::TYPE_GROUP,
]);
$builder->addRow()
    ->addCell(3000)->addText('Item')->end()
    ->addCell(2000)->addText('Price')->end()
    ->end();

$builder->getContentControl()->save('output.docx');
```

**After (v0.5.1 - FIXED):**
```php
use MkGrow\ContentControl\Bridge\TableBuilder;
use MkGrow\ContentControl\ContentControl;

$builder = new TableBuilder();
$builder->addRow()
    ->addCell(3000)->addText('Item')->end()
    ->addCell(2000)->addText('Price')->end()
    ->end();

// ✅ Apply table-level SDT manually AFTER building (no nested SDTs yet)
$cc = $builder->getContentControl();
// ❌ DO NOT USE: This creates nested SDTs when combined with withContentControl() on cells!
// The following code is shown for reference only - it will fail if you use cell-level SDTs:
// $cc->addContentControl($builder->getTable(), [
//     'tag' => 'invoice-table',
//     'alias' => 'Invoice Items',
//     'type' => ContentControl::TYPE_GROUP,
// ]);

$cc->save('output.docx');
```

**⚠️ WARNING**: This pattern still creates nested SDTs if you use `withContentControl()` on cells. See Migration Path 2 for the correct pattern.

---

#### Migration Path 2: Cell-Level SDTs Only (RECOMMENDED)

The **correct OOXML pattern** is to use Content Controls at the **cell level** only, not wrapping the entire table:

**Before (v0.5.0 - BROKEN):**
```php
$builder = new TableBuilder();
$builder->addContentControl(['tag' => 'invoice-table']);  // ❌ Creates nested SDTs

$builder->addRow()
    ->addCell(3000, ['tag' => 'item-1'])->addText('Item')->end()
    ->addCell(2000, ['tag' => 'price-1'])->addText('$100')->end()
    ->end();
```

**After (v0.5.1 - FIXED):**
```php
$builder = new TableBuilder();
// ✅ Remove table-level addContentControl() call entirely

$builder->addRow()
    ->addCell(3000)
        ->withContentControl([  // ✅ Cell-level SDT (recommended)
            'tag' => 'item-1',
            'alias' => 'Item Name',
            'inlineLevel' => true,  // Required for cell SDTs
        ])
        ->addText('Item')
        ->end()
    ->addCell(2000)
        ->withContentControl([
            'tag' => 'price-1',
            'alias' => 'Price',
            'inlineLevel' => true,
        ])
        ->addText('$100')
        ->end()
    ->end();

$builder->getContentControl()->save('output.docx');
```

**Benefits**:
- ✅ Valid OOXML structure (no nested SDTs)
- ✅ Compatible with Microsoft Word, LibreOffice, Google Docs
- ✅ Enables granular content protection at cell level
- ✅ Recommended by Microsoft documentation

---

#### Migration Path 3: Template Injection (Advanced)

If you were using `addContentControl()` with `injectInto()`, the pattern changes slightly:

**Before (v0.5.0 - BROKEN):**
```php
$builder = new TableBuilder();
$builder->addContentControl(['tag' => 'invoice-table']);
$builder->addRow()
    ->addCell(3000)->addText('Data')->end()
    ->end();

$processor = new ContentProcessor('template.docx');
$builder->injectInto($processor, 'data-placeholder');
$processor->save('output.docx');
```

**After (v0.5.1 - FIXED):**
```php
$builder = new TableBuilder();
// ✅ Remove addContentControl() call

$builder->addRow()
    ->addCell(3000)
        ->withContentControl(['tag' => 'cell-data', 'inlineLevel' => true])
        ->addText('Data')
        ->end()
    ->end();

$processor = new ContentProcessor('template.docx');
$builder->injectInto($processor, 'data-placeholder');
$processor->save('output.docx');
```

---

## Deprecations

### RowBuilder::end() and CellBuilder::end()

**Status**: Deprecated in v0.5.1, will be removed in v0.7.0 (18-month window)

**Why**: The `end()` method pattern is foreign to PHPWord conventions and adds cognitive overhead for developers.

**Action Required**: **None** (yet)

**Timeline**:
- **v0.5.1** (Feb 2026): Deprecation warnings emitted (once per script execution)
- **v0.6.0** (Q4 2026): Auto-close pattern introduced (end() becomes optional)
- **v0.7.0** (H1 2027): `end()` methods removed entirely

**Current Code** (will continue working until v0.7.0):
```php
$builder->addRow()
    ->addCell(3000)->addText('Data')->end()  // ⚠️ Deprecated but functional
    ->end();  // ⚠️ Deprecated but functional
```

**Future Code** (v0.6.0+ pattern, available in future release):
```php
// end() calls become optional (auto-close on next row/build)
$builder->addRow()
    ->addCell(3000)->addText('Data');  // ✅ Auto-closes cell
    // ✅ Auto-closes row
$builder->addRow()  // Starting new row auto-closes previous
    ->addCell(2000)->addText('More');
```

**Recommendation**: Continue using `end()` for now. Update when v0.6.0 is released.

---

## New Features

### TableBuilder::setTable() Method

**Added in**: v0.5.1  
**Purpose**: Enable decorating existing PhpWord Table instances (decouples from ContentControl lifecycle)

#### Use Case 1: Integration with Existing Documents

Before v0.5.1, TableBuilder required creating a new ContentControl instance. Now you can use it with existing PhpWord documents:

```php
use PhpOffice\PhpWord\PhpWord;
use MkGrow\ContentControl\Bridge\TableBuilder;

// User controls document structure
$phpWord = new PhpWord();
$section = $phpWord->addSection();
$section->addText('Document Header');

// Create table externally
$table = $section->addTable(['borderSize' => 6]);

// Decorate with TableBuilder fluent API
$builder = new TableBuilder();
$builder->setTable($table);  // ✅ New in v0.5.1
$builder->addRow()
    ->addCell(3000)->addText('Data')->end()
    ->end();

$section->addText('Document Footer');

// User saves (no ContentControl involved)
$writer = \PhpOffice\PhpWord\IOFactory::createWriter($phpWord, 'Word2007');
$writer->save('output.docx');
```

#### Use Case 2: Pre-Styled Tables

Apply complex styles to the table before passing to TableBuilder:

```php
$table = $section->addTable([
    'borderSize' => 6,
    'borderColor' => '000000',
    'cellMargin' => 80,
    'width' => 100 * 50,  // 100% width
]);

$builder = new TableBuilder();
$builder->setTable($table);  // ✅ Inherits all styles
$builder->addRow()->addCell(3000)->addText('Styled')->end()->end();
```

#### Constraints

1. **Must call BEFORE addRow()**: Cannot call `setTable()` after table creation
   ```php
   $builder = new TableBuilder();
   $builder->addRow();  // Creates internal table
   $builder->setTable($externalTable);  // ❌ Throws ContentControlException
   ```

2. **Cannot call AFTER setStyles()**: Apply styles to external table instead
   ```php
   $builder = new TableBuilder();
   $builder->setStyles(['borderSize' => 6]);
   $builder->setTable($externalTable);  // ❌ Throws ContentControlException
   ```

3. **Table should be empty**: Best practice is passing freshly created table
   ```php
   $table = $section->addTable();
   $table->addRow();  // ⚠️ Existing rows may conflict with builder expectations
   $builder->setTable($table);  // Works but not recommended
   ```

---

## FAQ

### Q: Why was this changed in a patch version (v0.5.1)?

**A**: Normally, removing a public method is a **major** version change (v0.5.0 → v1.0.0). However, we made an exception because:

1. **Security/Compliance Issue**: Creating invalid OOXML documents is a critical bug, not a feature
2. **Low User Impact**: Estimated <8% of users based on code analysis (no usage in sample files)
3. **Clear Migration Path**: All use cases have documented, working alternatives
4. **Prevent Future Damage**: Waiting for v1.0.0 (months away) would allow more broken documents to be created

While Semantic Versioning traditionally reserves breaking changes for major versions, we treat OOXML specification violations as **critical correctness bugs** rather than features. This aligns with SemVer's spirit of prioritizing correctness and preventing harm to users, even when it requires difficult judgment calls on versioning.

---

### Q: Can I still wrap entire tables in Content Controls?

**A**: Technically yes (via `ContentControl::addContentControl($table, $config)`), but it's **strongly discouraged** because:

1. If you also use cell-level SDTs, you create nested structures (OOXML violation)
2. Table-level protection locks the entire structure (inflexible)
3. Microsoft recommends cell-level or paragraph-level SDTs instead

**Recommended alternative**: Use `CellBuilder::withContentControl()` for granular protection.

---

### Q: Do I need to update if I don't use addContentControl()?

**A**: No action required. Your code will continue working without changes.

---

### Q: Will the deprecation warnings spam my production logs?

**A**: No. Warnings use a `static $warned` flag and emit **once per script execution**, not per method call. Example:

```php
for ($i = 0; $i < 100; $i++) {
    $builder->addRow()->addCell(3000)->addText('Data')->end()->end();
}
// Only 2 warnings total (1 for CellBuilder::end, 1 for RowBuilder::end)
```

You can suppress deprecation warnings in production if needed:
```php
// php.ini or .htaccess
error_reporting = E_ALL & ~E_DEPRECATED

// Or in code (not recommended)
error_reporting(E_ALL & ~E_USER_DEPRECATED);
```

---

### Q: What if I need table-level metadata but not locking?

**A**: Use PhpWord's native table properties instead of Content Controls:

```php
$table->setWidth(100 * 50);
$table->setUnit('pct');
// Store metadata in custom XML parts (advanced, see PhpWord docs)
```

For true metadata tagging, consider cell-level SDTs with `tag` attributes.

---

## Migration Effort Estimate

| Use Case | Affected Code | Effort | Notes |
|----------|--------------|--------|-------|
| **No addContentControl() usage** | All files | **0 min** | No changes needed |
| **Simple table with addContentControl()** | 1-5 method calls | **5 min** | Remove `addContentControl()` call, test output |
| **Table + cell-level SDTs** | Mixed usage | **10 min** | Switch to cell-level only, verify OOXML validity |
| **Template injection workflow** | `injectInto()` calls | **15 min** | Remove table-level SDT, ensure template compatibility |
| **Complex nested structures** | Custom patterns | **30+ min** | May require architecture review |

**Total estimated impact**: 5-15 minutes per affected file for 90% of users.

---

## Testing Checklist

After migration, verify:

- [ ] Code compiles without errors (`composer analyse`)
- [ ] Tests pass (`composer test`)
- [ ] Generated `.docx` files open in Microsoft Word without warnings
- [ ] Content Controls appear in Word's "Developer" tab → "Design Mode"
- [ ] No nested SDT structures in XML (`unzip output.docx && cat word/document.xml | grep -c '<w:sdt><w:sdtContent><w:sdt>'` should return 0)

---

## Additional Resources

- **API Documentation**: [docs/TableBuilder.md](../TableBuilder.md)
- **OOXML Specification**: ISO/IEC 29500-1:2016 §17.5.2
- **GitHub Issues**: [v0.5.1 Milestone](https://github.com/mateusbandeira182/ContentControl/milestone/5)
- **Sample Files**: See `samples/` directory for working examples

---

## Support

If you encounter migration issues:

1. Check [GitHub Issues](https://github.com/mateusbandeira182/ContentControl/issues) for existing reports
2. Provide a minimal reproducible example when opening new issues
3. Include your PHP version, PhpWord version, and ContentControl version

**Version Info**:
- Migrating FROM: v0.5.0
- Migrating TO: v0.5.1
- PHP Requirement: ≥8.2
- PhpWord Requirement: ^1.4
